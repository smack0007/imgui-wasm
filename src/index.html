<!DOCTYPE html>
<html>
  <head></head>
  <body>
    <script type="module">
      const ERRNO_SUCCESS = 0;
      const ERRNO_BADF = 8;
      const ERRNO_NOSYS = 52;

      const FD_STDOUT = 1;
      const FD_STDERR = 2;

      const memory = new WebAssembly.Memory({ initial: 256 });
      const { instance } = await WebAssembly.instantiateStreaming(
        fetch("./imgui.wasm"),
        {
          env: { memory },
          wasi_snapshot_preview1: {
            args_get: function () {
              console.info("args_get");
              return ERRNO_NOSYS;
            },
            args_sizes_get: function () {
              console.info("args_sizes_get");
              return ERRNO_NOSYS;
            },
            clock_res_get: function () {
              console.info("clock_res_get");
              return ERRNO_NOSYS;
            },
            clock_time_get: function () {
              console.info("clock_time_get");
              return ERRNO_NOSYS;
            },
            environ_get: function () {
              console.info("environ_get");
              return ERRNO_NOSYS;
            },
            environ_sizes_get: function () {
              console.info("environ_sizes_get");
              return ERRNO_NOSYS;
            },
            fd_advise: function () {
              console.info("fd_advise");
              return ERRNO_NOSYS;
            },
            fd_allocate: function () {
              console.info("fd_allocate");
              return ERRNO_NOSYS;
            },
            fd_close: function () {
              console.info("fd_close");
              return ERRNO_NOSYS;
            },
            fd_datasync: function () {
              console.info("fd_datasync");
              return ERRNO_NOSYS;
            },
            fd_fdstat_get: function () {
              console.info("fd_fdstat_get");
              return ERRNO_NOSYS;
            },
            fd_fdstat_set_flags: function () {
              console.info("fd_fdstat_set_flags");
              return ERRNO_NOSYS;
            },
            fd_fdstat_set_rights: function () {
              console.info("fd_fdstat_set_rights");
              return ERRNO_NOSYS;
            },
            fd_filestat_get: function () {
              console.info("fd_filestat_get");
              return ERRNO_NOSYS;
            },
            fd_filestat_set_size: function () {
              console.info("fd_filestat_set_size");
              return ERRNO_NOSYS;
            },
            fd_filestat_set_times: function () {
              console.info("fd_filestat_set_times");
              return ERRNO_NOSYS;
            },
            fd_pread: function () {
              console.info("fd_pread");
              return ERRNO_NOSYS;
            },
            fd_prestat_dir_name: function () {
              console.info("fd_prestat_dir_name");
              return ERRNO_NOSYS;
            },
            fd_prestat_get: function () {
              console.info("fd_prestat_get");
              return ERRNO_NOSYS;
            },
            fd_pwrite: function () {
              console.info("fd_pwrite");
              return ERRNO_NOSYS;
            },
            fd_read: function () {
              console.info("fd_read");
              return ERRNO_NOSYS;
            },
            fd_readdir: function () {
              console.info("fd_readdir");
              return ERRNO_NOSYS;
            },
            fd_renumber: function () {
              console.info("fd_renumber");
              return ERRNO_NOSYS;
            },
            fd_seek: function () {
              console.info("fd_seek");
              return ERRNO_NOSYS;
            },
            fd_sync: function () {
              console.info("fd_sync");
              return ERRNO_NOSYS;
            },
            fd_tell: function () {
              console.info("fd_tell");
              return ERRNO_NOSYS;
            },
            fd_write: function (fd, iovsOffset, iovsLength, nwrittenOffset) {
              console.debug(
                "fd_write",
                fd,
                iovsOffset,
                iovsLength,
                nwrittenOffset
              );

              if (fd !== FD_STDOUT && fd !== FD_STDERR) {
                return ERRNO_BADF;
              }

              const memoryView = new DataView(memory.buffer);

              let nwritten = 0;
              for (let i = 0; i < iovsLength; i++) {
                const dataOffset = memoryView.getUint32(iovsOffset, true);
                iovsOffset += 4;

                const dataLength = memoryView.getUint32(iovsOffset, true);
                iovsOffset += 4;

                if (dataLength === 0) {
                  continue;
                }

                const data = new Uint8Array(
                  memory.buffer,
                  dataOffset,
                  dataLength
                );
                const string = new TextDecoder().decode(data);

                if (fd === FD_STDOUT) {
                  console.info(string);
                } else {
                  console.error(string);
                }
              }

              memoryView.setUint32(nwrittenOffset, nwritten, true);

              return ERRNO_NOSYS;
            },
            path_create_directory: function () {
              console.info("path_create_directory");
              return ERRNO_NOSYS;
            },
            path_filestat_get: function () {
              console.info("path_filestat_get");
              return ERRNO_NOSYS;
            },
            path_filestat_set_times: function () {
              console.info("path_filestat_set_times");
              return ERRNO_NOSYS;
            },
            path_link: function () {
              console.info("path_link");
              return ERRNO_NOSYS;
            },
            path_open: function () {
              console.info("path_open");
              return ERRNO_NOSYS;
            },
            path_readlink: function () {
              console.info("path_readlink");
              return ERRNO_NOSYS;
            },
            path_remove_directory: function () {
              console.info("path_remove_directory");
              return ERRNO_NOSYS;
            },
            path_rename: function () {
              console.info("path_rename");
              return ERRNO_NOSYS;
            },
            path_symlink: function () {
              console.info("path_symlink");
              return ERRNO_NOSYS;
            },
            path_unlink_file: function () {
              console.info("path_unlink_file");
              return ERRNO_NOSYS;
            },
            poll_oneoff: function () {
              console.info("poll_oneoff");
              return ERRNO_NOSYS;
            },
            proc_exit: function () {
              console.info("proc_exit");
              return ERRNO_NOSYS;
            },
            proc_raise: function () {
              console.info("proc_raise");
              return ERRNO_NOSYS;
            },
            random_get: function () {
              console.info("random_get");
              return ERRNO_NOSYS;
            },
            sched_yield: function () {
              console.info("sched_yield");
              return ERRNO_NOSYS;
            },
            sock_accept: function () {
              console.info("sock_accept");
              return ERRNO_NOSYS;
            },
            sock_recv: function () {
              console.info("sock_recv");
              return ERRNO_NOSYS;
            },
            sock_send: function () {
              console.info("sock_send");
              return ERRNO_NOSYS;
            },
            sock_shutdown: function () {
              console.info("sock_shutdown");
              return ERRNO_NOSYS;
            },
          },
        }
      );

      const __heap_base = instance.exports.__heap_base;

      function toCString(string) {
        for (let i = 0; i < string.length; i++) {
          memory[__heap_base + i] = string.charCodeAt(i);
        }

        memory[__heap_base + string.length] = 0;

        return __heap_base;
      }

      console.dir(instance.exports);
      console.info(instance.exports.__heap_base);

      console.info(instance.exports.igGET_FLT_MAX());

      const igContext = instance.exports.igCreateContext(null);
      console.info(igContext);
      instance.exports.igStyleColorsDark(null);

      const ioPtr = instance.exports.igGetIO();
      console.info("ioPtr", ioPtr);
      const memoryView = new DataView(memory.buffer);
      memoryView.setFloat32(ioPtr + 8, 800.0, true);
      memoryView.setFloat32(ioPtr + 12, 600.0, true);

      instance.exports.igNewFrame();
      instance.exports.igShowDemoWindow(true);
      instance.exports.igRender();
      console.info(instance.exports.igGetDrawData());
    </script>
  </body>
</html>
